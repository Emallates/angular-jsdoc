<head>
  <link href="../css/prettify.css" type="text/css" rel="stylesheet">
  <script src="../js/prettify.js"></script>
</head>
<body onload="prettyPrint()">
  <div>Path: /Users/allen/github/angularjs-google-maps/services/attr2_options.js</div>
  <div>TOC: [object Object]</div>
  <div>Total Number Of Lines: 310</div>
  <pre style="display:inline-block;text-align:right"><a id="line1">1.</a>
<a id="line2">2.</a>
<a id="line3">3.</a>
<a id="line4">4.</a>
<a id="line5">5.</a>
<a id="line6">6.</a>
<a id="line7">7.</a>
<a id="line8">8.</a>
<a id="line9">9.</a>
<a id="line10">10.</a>
<a id="line11">11.</a>
<a id="line12">12.</a>
<a id="line13">13.</a>
<a id="line14">14.</a>
<a id="line15">15.</a>
<a id="line16">16.</a>
<a id="line17">17.</a>
<a id="line18">18.</a>
<a id="line19">19.</a>
<a id="line20">20.</a>
<a id="line21">21.</a>
<a id="line22">22.</a>
<a id="line23">23.</a>
<a id="line24">24.</a>
<a id="line25">25.</a>
<a id="line26">26.</a>
<a id="line27">27.</a>
<a id="line28">28.</a>
<a id="line29">29.</a>
<a id="line30">30.</a>
<a id="line31">31.</a>
<a id="line32">32.</a>
<a id="line33">33.</a>
<a id="line34">34.</a>
<a id="line35">35.</a>
<a id="line36">36.</a>
<a id="line37">37.</a>
<a id="line38">38.</a>
<a id="line39">39.</a>
<a id="line40">40.</a>
<a id="line41">41.</a>
<a id="line42">42.</a>
<a id="line43">43.</a>
<a id="line44">44.</a>
<a id="line45">45.</a>
<a id="line46">46.</a>
<a id="line47">47.</a>
<a id="line48">48.</a>
<a id="line49">49.</a>
<a id="line50">50.</a>
<a id="line51">51.</a>
<a id="line52">52.</a>
<a id="line53">53.</a>
<a id="line54">54.</a>
<a id="line55">55.</a>
<a id="line56">56.</a>
<a id="line57">57.</a>
<a id="line58">58.</a>
<a id="line59">59.</a>
<a id="line60">60.</a>
<a id="line61">61.</a>
<a id="line62">62.</a>
<a id="line63">63.</a>
<a id="line64">64.</a>
<a id="line65">65.</a>
<a id="line66">66.</a>
<a id="line67">67.</a>
<a id="line68">68.</a>
<a id="line69">69.</a>
<a id="line70">70.</a>
<a id="line71">71.</a>
<a id="line72">72.</a>
<a id="line73">73.</a>
<a id="line74">74.</a>
<a id="line75">75.</a>
<a id="line76">76.</a>
<a id="line77">77.</a>
<a id="line78">78.</a>
<a id="line79">79.</a>
<a id="line80">80.</a>
<a id="line81">81.</a>
<a id="line82">82.</a>
<a id="line83">83.</a>
<a id="line84">84.</a>
<a id="line85">85.</a>
<a id="line86">86.</a>
<a id="line87">87.</a>
<a id="line88">88.</a>
<a id="line89">89.</a>
<a id="line90">90.</a>
<a id="line91">91.</a>
<a id="line92">92.</a>
<a id="line93">93.</a>
<a id="line94">94.</a>
<a id="line95">95.</a>
<a id="line96">96.</a>
<a id="line97">97.</a>
<a id="line98">98.</a>
<a id="line99">99.</a>
<a id="line100">100.</a>
<a id="line101">101.</a>
<a id="line102">102.</a>
<a id="line103">103.</a>
<a id="line104">104.</a>
<a id="line105">105.</a>
<a id="line106">106.</a>
<a id="line107">107.</a>
<a id="line108">108.</a>
<a id="line109">109.</a>
<a id="line110">110.</a>
<a id="line111">111.</a>
<a id="line112">112.</a>
<a id="line113">113.</a>
<a id="line114">114.</a>
<a id="line115">115.</a>
<a id="line116">116.</a>
<a id="line117">117.</a>
<a id="line118">118.</a>
<a id="line119">119.</a>
<a id="line120">120.</a>
<a id="line121">121.</a>
<a id="line122">122.</a>
<a id="line123">123.</a>
<a id="line124">124.</a>
<a id="line125">125.</a>
<a id="line126">126.</a>
<a id="line127">127.</a>
<a id="line128">128.</a>
<a id="line129">129.</a>
<a id="line130">130.</a>
<a id="line131">131.</a>
<a id="line132">132.</a>
<a id="line133">133.</a>
<a id="line134">134.</a>
<a id="line135">135.</a>
<a id="line136">136.</a>
<a id="line137">137.</a>
<a id="line138">138.</a>
<a id="line139">139.</a>
<a id="line140">140.</a>
<a id="line141">141.</a>
<a id="line142">142.</a>
<a id="line143">143.</a>
<a id="line144">144.</a>
<a id="line145">145.</a>
<a id="line146">146.</a>
<a id="line147">147.</a>
<a id="line148">148.</a>
<a id="line149">149.</a>
<a id="line150">150.</a>
<a id="line151">151.</a>
<a id="line152">152.</a>
<a id="line153">153.</a>
<a id="line154">154.</a>
<a id="line155">155.</a>
<a id="line156">156.</a>
<a id="line157">157.</a>
<a id="line158">158.</a>
<a id="line159">159.</a>
<a id="line160">160.</a>
<a id="line161">161.</a>
<a id="line162">162.</a>
<a id="line163">163.</a>
<a id="line164">164.</a>
<a id="line165">165.</a>
<a id="line166">166.</a>
<a id="line167">167.</a>
<a id="line168">168.</a>
<a id="line169">169.</a>
<a id="line170">170.</a>
<a id="line171">171.</a>
<a id="line172">172.</a>
<a id="line173">173.</a>
<a id="line174">174.</a>
<a id="line175">175.</a>
<a id="line176">176.</a>
<a id="line177">177.</a>
<a id="line178">178.</a>
<a id="line179">179.</a>
<a id="line180">180.</a>
<a id="line181">181.</a>
<a id="line182">182.</a>
<a id="line183">183.</a>
<a id="line184">184.</a>
<a id="line185">185.</a>
<a id="line186">186.</a>
<a id="line187">187.</a>
<a id="line188">188.</a>
<a id="line189">189.</a>
<a id="line190">190.</a>
<a id="line191">191.</a>
<a id="line192">192.</a>
<a id="line193">193.</a>
<a id="line194">194.</a>
<a id="line195">195.</a>
<a id="line196">196.</a>
<a id="line197">197.</a>
<a id="line198">198.</a>
<a id="line199">199.</a>
<a id="line200">200.</a>
<a id="line201">201.</a>
<a id="line202">202.</a>
<a id="line203">203.</a>
<a id="line204">204.</a>
<a id="line205">205.</a>
<a id="line206">206.</a>
<a id="line207">207.</a>
<a id="line208">208.</a>
<a id="line209">209.</a>
<a id="line210">210.</a>
<a id="line211">211.</a>
<a id="line212">212.</a>
<a id="line213">213.</a>
<a id="line214">214.</a>
<a id="line215">215.</a>
<a id="line216">216.</a>
<a id="line217">217.</a>
<a id="line218">218.</a>
<a id="line219">219.</a>
<a id="line220">220.</a>
<a id="line221">221.</a>
<a id="line222">222.</a>
<a id="line223">223.</a>
<a id="line224">224.</a>
<a id="line225">225.</a>
<a id="line226">226.</a>
<a id="line227">227.</a>
<a id="line228">228.</a>
<a id="line229">229.</a>
<a id="line230">230.</a>
<a id="line231">231.</a>
<a id="line232">232.</a>
<a id="line233">233.</a>
<a id="line234">234.</a>
<a id="line235">235.</a>
<a id="line236">236.</a>
<a id="line237">237.</a>
<a id="line238">238.</a>
<a id="line239">239.</a>
<a id="line240">240.</a>
<a id="line241">241.</a>
<a id="line242">242.</a>
<a id="line243">243.</a>
<a id="line244">244.</a>
<a id="line245">245.</a>
<a id="line246">246.</a>
<a id="line247">247.</a>
<a id="line248">248.</a>
<a id="line249">249.</a>
<a id="line250">250.</a>
<a id="line251">251.</a>
<a id="line252">252.</a>
<a id="line253">253.</a>
<a id="line254">254.</a>
<a id="line255">255.</a>
<a id="line256">256.</a>
<a id="line257">257.</a>
<a id="line258">258.</a>
<a id="line259">259.</a>
<a id="line260">260.</a>
<a id="line261">261.</a>
<a id="line262">262.</a>
<a id="line263">263.</a>
<a id="line264">264.</a>
<a id="line265">265.</a>
<a id="line266">266.</a>
<a id="line267">267.</a>
<a id="line268">268.</a>
<a id="line269">269.</a>
<a id="line270">270.</a>
<a id="line271">271.</a>
<a id="line272">272.</a>
<a id="line273">273.</a>
<a id="line274">274.</a>
<a id="line275">275.</a>
<a id="line276">276.</a>
<a id="line277">277.</a>
<a id="line278">278.</a>
<a id="line279">279.</a>
<a id="line280">280.</a>
<a id="line281">281.</a>
<a id="line282">282.</a>
<a id="line283">283.</a>
<a id="line284">284.</a>
<a id="line285">285.</a>
<a id="line286">286.</a>
<a id="line287">287.</a>
<a id="line288">288.</a>
<a id="line289">289.</a>
<a id="line290">290.</a>
<a id="line291">291.</a>
<a id="line292">292.</a>
<a id="line293">293.</a>
<a id="line294">294.</a>
<a id="line295">295.</a>
<a id="line296">296.</a>
<a id="line297">297.</a>
<a id="line298">298.</a>
<a id="line299">299.</a>
<a id="line300">300.</a>
<a id="line301">301.</a>
<a id="line302">302.</a>
<a id="line303">303.</a>
<a id="line304">304.</a>
<a id="line305">305.</a>
<a id="line306">306.</a>
<a id="line307">307.</a>
<a id="line308">308.</a>
<a id="line309">309.</a>
<a id="line310">310.</a>
  </pre>
  <pre class="prettyprint" style="display:inline-block">/**
 * @ngdoc service
 * @name Attr2Options
 * @description 
 *   Converts tag attributes to options used by google api v3 objects, map, marker, polygon, circle, etc.
 */
/* global google */
(function() {
  'use strict';

  var SPECIAL_CHARS_REGEXP = /([\:\-\_]+(.))/g;
  var MOZ_HACK_REGEXP = /^moz([A-Z])/;  

  function camelCase(name) {
    return name.
      replace(SPECIAL_CHARS_REGEXP, function(_, separator, letter, offset) {
        return offset ? letter.toUpperCase() : letter;
      }).
      replace(MOZ_HACK_REGEXP, 'Moz$1');
  }

  function JSONize(str) {
    try {       // if parsable already, return as it is
      JSON.parse(str);
      return str;
    } catch(e) { // if not parsable, change little
      return str
        // wrap keys without quote with valid double quote
        .replace(/([\$\w]+)\s*:/g, function(_, $1){return '"'+$1+'":'})
        // replacing single quote wrapped ones to double quote 
        .replace(/'([^']+)'/g, function(_, $1){return '"'+$1+'"'})
    }
  }

  var Attr2Options = function($parse, $timeout, NavigatorGeolocation, GeoCoder) { 

    /**
     * Returns the attributes of an element as hash
     * @memberof Attr2Options
     * @param {HTMLElement} el html element
     * @returns {Hash} attributes
     */
    var orgAttributes = function(el) {
      (el.length > 0) && (el = el[0]);
      var orgAttributes = {};
      for (var i=0; i&lt;el.attributes.length; i++) {
        var attr = el.attributes[i];
        orgAttributes[attr.name] = attr.value;
      }
      return orgAttributes;
    };

    var toOptionValue = function(input, options) {
      var output, key=options.key, scope=options.scope;
      try { // 1. Number?
        var num = Number(input);
        if (isNaN(num)) {
          throw "Not a number";
        } else  {
          output = num;
        }
      } catch(err) { 
        try { // 2.JSON?
          if (input.match(/^[\+\-]?[0-9\.]+,[ ]*\ ?[\+\-]?[0-9\.]+$/)) { // i.e "-1.0, 89.89"
            input = "["+input+"]";
          }
          output = JSON.parse(JSONize(input));
          if (output instanceof Array) {
            var t1stEl = output[0];
            if (t1stEl.constructor == Object) { // [{a:1}] : not lat/lng ones
            } else if (t1stEl.constructor == Array) { // [[1,2],[3,4]] 
              output =  output.map(function(el) {
                return new google.maps.LatLng(el[0], el[1]);
              });
            } else if(!isNaN(parseFloat(t1stEl)) && isFinite(t1stEl)) {
              return new google.maps.LatLng(output[0], output[1]);
            }
          }
        } catch(err2) {
          // 3. Object Expression. i.e. LatLng(80,-49)
          if (input.match(/^[A-Z][a-zA-Z0-9]+\(.*\)$/)) {
            try {
              var exp = "new google.maps."+input;
              output = eval(exp); // TODO, still eval
            } catch(e) {
              output = input;
            } 
          // 4. Object Expression. i.e. MayTypeId.HYBRID 
          } else if (input.match(/^([A-Z][a-zA-Z0-9]+)\.([A-Z]+)$/)) {
            try {
              var matches = input.match(/^([A-Z][a-zA-Z0-9]+)\.([A-Z]+)$/);
              output = google.maps[matches[1]][matches[2]];
            } catch(e) {
              output = input;
            } 
          // 5. Object Expression. i.e. HYBRID 
          } else if (input.match(/^[A-Z]+$/)) {
            try {
              var capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
              if (key.match(/temperatureUnit|windSpeedUnit|labelColor/)) {
                capitalizedKey = capitalizedKey.replace(/s$/,"");
                output = google.maps.weather[capitalizedKey][input];
              } else {
                output = google.maps[capitalizedKey][input];
              }
            } catch(e) {
              output = input;
            }
          } else {
            output = input;
          }
        } // catch(err2)
      } // catch(err)
      return output;
    };

    var getAttrsToObserve = function(attrs) {
      var attrsToObserve = [];
      if (attrs["ng-repeat"] || attrs.ngRepeat) {  // if element is created by ng-repeat, don't observe any
        void(0);
      } else {
        for (var attrName in attrs) {
          var attrValue = attrs[attrName];
          if (attrValue && attrValue.match(/\{\{.*\}\}/)) { // if attr value is {{..}}
            console.log('setting attribute to observe', attrName, camelCase(attrName), attrValue);
            attrsToObserve.push(camelCase(attrName));
          }
        }
      }
      return attrsToObserve;
    };

    /**
     * filters attributes by skipping angularjs methods $.. $$..
     * @memberof Attr2Options
     * @param {Hash} attrs tag attributes
     * @returns {Hash} filterd attributes
     */
    var filter = function(attrs) {
      var options = {};
      for(var key in attrs) {
        if (key.match(/^\$/) || key.match(/^ng[A-Z]/)) {
          void(0);
        } else {
          options[key] = attrs[key];
        }
      }
      return options;
    };

    /**
     * converts attributes hash to Google Maps API v3 options  
     * ```
     *  . converts numbers to number   
     *  . converts class-like string to google maps instance   
     *    i.e. `LatLng(1,1)` to `new google.maps.LatLng(1,1)`  
     *  . converts constant-like string to google maps constant    
     *    i.e. `MapTypeId.HYBRID` to `google.maps.MapTypeId.HYBRID`   
     *    i.e. `HYBRID"` to `google.maps.MapTypeId.HYBRID`  
     * ```
     * @memberof Attr2Options
     * @param {Hash} attrs tag attributes
     * @param {scope} scope angularjs scope
     * @returns {Hash} options converted attributess
     */
    var getOptions = function(attrs, scope) {
      var options = {};
      for(var key in attrs) {
        if (attrs[key]) {
          if (key.match(/^on[A-Z]/)) { //skip events, i.e. on-click
            continue;
          } else if (key.match(/ControlOptions$/)) { // skip controlOptions
            continue;
          } else {
            options[key] = toOptionValue(attrs[key], {scope:scope, key: key});
          }
        } // if (attrs[key])
      } // for(var key in attrs)
      return options;
    };

    /**
     * converts attributes hash to scope-specific event function 
     * @memberof Attr2Options
     * @param {scope} scope angularjs scope
     * @param {Hash} attrs tag attributes
     * @returns {Hash} events converted events
     */
    var getEvents = function(scope, attrs) {
      var events = {};
      var toLowercaseFunc = function($1){
        return "_"+$1.toLowerCase();
      };
      var eventFunc = function(attrValue) {
        var matches = attrValue.match(/([^\(]+)\(([^\)]*)\)/);
        var funcName = matches[1];
        var argsStr = matches[2].replace(/event[ ,]*/,'');  //remove string 'event'
        var argsExpr = $parse("["+argsStr+"]"); //for perf when triggering event
        return function(event) {
          var args = argsExpr(scope); //get args here to pass updated model values
          function index(obj,i) {return obj[i];}
          var f = funcName.split('.').reduce(index, scope);
          f && f.apply(this, [event].concat(args));
          $timeout( function() {
            scope.$apply();
          });
        };
      };

      for(var key in attrs) {
        if (attrs[key]) {
          if (!key.match(/^on[A-Z]/)) { //skip if not events
            continue;
          }
          
          //get event name as underscored. i.e. zoom_changed
          var eventName = key.replace(/^on/,'');
          eventName = eventName.charAt(0).toLowerCase() + eventName.slice(1);
          eventName = eventName.replace(/([A-Z])/g, toLowercaseFunc);

          var attrValue = attrs[key];
          events[eventName] = new eventFunc(attrValue);
        }
      }
      return events;
    };

    /**
     * control means map controls, i.e streetview, pan, etc, not a general control
     * @memberof Attr2Options
     * @param {Hash} filtered filtered tag attributes
     * @returns {Hash} Google Map options
     */
    var getControlOptions = function(filtered) {
      var controlOptions = {};
      if (typeof filtered != 'object') {
        return false;
      }

      for (var attr in filtered) {
        if (filtered[attr]) {
          if (!attr.match(/(.*)ControlOptions$/)) { 
            continue; // if not controlOptions, skip it
          }

          //change invalid json to valid one, i.e. {foo:1} to {"foo": 1}
          var orgValue = filtered[attr];
          var newValue = orgValue.replace(/'/g, '"');
          newValue = newValue.replace(/([^"]+)|("[^"]+")/g, function($0, $1, $2) {
            if ($1) {
              return $1.replace(/([a-zA-Z0-9]+?):/g, '"$1":');
            } else {
              return $2; 
            } 
          });
          try {
            var options = JSON.parse(newValue);
            for (var key in options) { //assign the right values
              if (options[key]) {
                var value = options[key];
                if (typeof value === 'string') {
                  value = value.toUpperCase();
                } else if (key === "mapTypeIds") {
                  value = value.map( function(str) {
                    if (str.match(/^[A-Z]+$/)) { // if constant
                      return google.maps.MapTypeId[str.toUpperCase()];
                    } else { // else, custom map-type
                      return str;
                    }
                  });
                } 
                
                if (key === "style") {
                  var str = attr.charAt(0).toUpperCase() + attr.slice(1);
                  var objName = str.replace(/Options$/,'')+"Style";
                  options[key] = google.maps[objName][value];
                } else if (key === "position") {
                  options[key] = google.maps.ControlPosition[value];
                } else {
                  options[key] = value;
                }
              }
            }
            controlOptions[attr] = options;
          } catch (e) {
            console.error('invald option for', attr, newValue, e, e.stack);
          }
        }
      } // for

      return controlOptions;
    };

    return {
      camelCase: camelCase,
      filter: filter,
      getOptions: getOptions,
      getEvents: getEvents,
      getControlOptions: getControlOptions,
      toOptionValue: toOptionValue,
      getAttrsToObserve: getAttrsToObserve,
      orgAttributes: orgAttributes
    }; // return

  }; 
  Attr2Options.$inject= ['$parse', '$timeout', 'NavigatorGeolocation', 'GeoCoder'];

  angular.module('ngMap').service('Attr2Options', Attr2Options);
})();

  </pre>
</body>
