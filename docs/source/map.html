<head>
  <link href="../css/prettify.css" type="text/css" rel="stylesheet">
  <script src="../js/prettify.js"></script>
</head>
<body onload="prettyPrint()">
  <div>Path: /Users/allen/github/angularjs-google-maps/directives/map.js</div>
  <div>TOC: [object Object]</div>
  <div>Total Number Of Lines: 214</div>
  <pre style="display:inline-block;text-align:right"><a id="line1">1.</a>
<a id="line2">2.</a>
<a id="line3">3.</a>
<a id="line4">4.</a>
<a id="line5">5.</a>
<a id="line6">6.</a>
<a id="line7">7.</a>
<a id="line8">8.</a>
<a id="line9">9.</a>
<a id="line10">10.</a>
<a id="line11">11.</a>
<a id="line12">12.</a>
<a id="line13">13.</a>
<a id="line14">14.</a>
<a id="line15">15.</a>
<a id="line16">16.</a>
<a id="line17">17.</a>
<a id="line18">18.</a>
<a id="line19">19.</a>
<a id="line20">20.</a>
<a id="line21">21.</a>
<a id="line22">22.</a>
<a id="line23">23.</a>
<a id="line24">24.</a>
<a id="line25">25.</a>
<a id="line26">26.</a>
<a id="line27">27.</a>
<a id="line28">28.</a>
<a id="line29">29.</a>
<a id="line30">30.</a>
<a id="line31">31.</a>
<a id="line32">32.</a>
<a id="line33">33.</a>
<a id="line34">34.</a>
<a id="line35">35.</a>
<a id="line36">36.</a>
<a id="line37">37.</a>
<a id="line38">38.</a>
<a id="line39">39.</a>
<a id="line40">40.</a>
<a id="line41">41.</a>
<a id="line42">42.</a>
<a id="line43">43.</a>
<a id="line44">44.</a>
<a id="line45">45.</a>
<a id="line46">46.</a>
<a id="line47">47.</a>
<a id="line48">48.</a>
<a id="line49">49.</a>
<a id="line50">50.</a>
<a id="line51">51.</a>
<a id="line52">52.</a>
<a id="line53">53.</a>
<a id="line54">54.</a>
<a id="line55">55.</a>
<a id="line56">56.</a>
<a id="line57">57.</a>
<a id="line58">58.</a>
<a id="line59">59.</a>
<a id="line60">60.</a>
<a id="line61">61.</a>
<a id="line62">62.</a>
<a id="line63">63.</a>
<a id="line64">64.</a>
<a id="line65">65.</a>
<a id="line66">66.</a>
<a id="line67">67.</a>
<a id="line68">68.</a>
<a id="line69">69.</a>
<a id="line70">70.</a>
<a id="line71">71.</a>
<a id="line72">72.</a>
<a id="line73">73.</a>
<a id="line74">74.</a>
<a id="line75">75.</a>
<a id="line76">76.</a>
<a id="line77">77.</a>
<a id="line78">78.</a>
<a id="line79">79.</a>
<a id="line80">80.</a>
<a id="line81">81.</a>
<a id="line82">82.</a>
<a id="line83">83.</a>
<a id="line84">84.</a>
<a id="line85">85.</a>
<a id="line86">86.</a>
<a id="line87">87.</a>
<a id="line88">88.</a>
<a id="line89">89.</a>
<a id="line90">90.</a>
<a id="line91">91.</a>
<a id="line92">92.</a>
<a id="line93">93.</a>
<a id="line94">94.</a>
<a id="line95">95.</a>
<a id="line96">96.</a>
<a id="line97">97.</a>
<a id="line98">98.</a>
<a id="line99">99.</a>
<a id="line100">100.</a>
<a id="line101">101.</a>
<a id="line102">102.</a>
<a id="line103">103.</a>
<a id="line104">104.</a>
<a id="line105">105.</a>
<a id="line106">106.</a>
<a id="line107">107.</a>
<a id="line108">108.</a>
<a id="line109">109.</a>
<a id="line110">110.</a>
<a id="line111">111.</a>
<a id="line112">112.</a>
<a id="line113">113.</a>
<a id="line114">114.</a>
<a id="line115">115.</a>
<a id="line116">116.</a>
<a id="line117">117.</a>
<a id="line118">118.</a>
<a id="line119">119.</a>
<a id="line120">120.</a>
<a id="line121">121.</a>
<a id="line122">122.</a>
<a id="line123">123.</a>
<a id="line124">124.</a>
<a id="line125">125.</a>
<a id="line126">126.</a>
<a id="line127">127.</a>
<a id="line128">128.</a>
<a id="line129">129.</a>
<a id="line130">130.</a>
<a id="line131">131.</a>
<a id="line132">132.</a>
<a id="line133">133.</a>
<a id="line134">134.</a>
<a id="line135">135.</a>
<a id="line136">136.</a>
<a id="line137">137.</a>
<a id="line138">138.</a>
<a id="line139">139.</a>
<a id="line140">140.</a>
<a id="line141">141.</a>
<a id="line142">142.</a>
<a id="line143">143.</a>
<a id="line144">144.</a>
<a id="line145">145.</a>
<a id="line146">146.</a>
<a id="line147">147.</a>
<a id="line148">148.</a>
<a id="line149">149.</a>
<a id="line150">150.</a>
<a id="line151">151.</a>
<a id="line152">152.</a>
<a id="line153">153.</a>
<a id="line154">154.</a>
<a id="line155">155.</a>
<a id="line156">156.</a>
<a id="line157">157.</a>
<a id="line158">158.</a>
<a id="line159">159.</a>
<a id="line160">160.</a>
<a id="line161">161.</a>
<a id="line162">162.</a>
<a id="line163">163.</a>
<a id="line164">164.</a>
<a id="line165">165.</a>
<a id="line166">166.</a>
<a id="line167">167.</a>
<a id="line168">168.</a>
<a id="line169">169.</a>
<a id="line170">170.</a>
<a id="line171">171.</a>
<a id="line172">172.</a>
<a id="line173">173.</a>
<a id="line174">174.</a>
<a id="line175">175.</a>
<a id="line176">176.</a>
<a id="line177">177.</a>
<a id="line178">178.</a>
<a id="line179">179.</a>
<a id="line180">180.</a>
<a id="line181">181.</a>
<a id="line182">182.</a>
<a id="line183">183.</a>
<a id="line184">184.</a>
<a id="line185">185.</a>
<a id="line186">186.</a>
<a id="line187">187.</a>
<a id="line188">188.</a>
<a id="line189">189.</a>
<a id="line190">190.</a>
<a id="line191">191.</a>
<a id="line192">192.</a>
<a id="line193">193.</a>
<a id="line194">194.</a>
<a id="line195">195.</a>
<a id="line196">196.</a>
<a id="line197">197.</a>
<a id="line198">198.</a>
<a id="line199">199.</a>
<a id="line200">200.</a>
<a id="line201">201.</a>
<a id="line202">202.</a>
<a id="line203">203.</a>
<a id="line204">204.</a>
<a id="line205">205.</a>
<a id="line206">206.</a>
<a id="line207">207.</a>
<a id="line208">208.</a>
<a id="line209">209.</a>
<a id="line210">210.</a>
<a id="line211">211.</a>
<a id="line212">212.</a>
<a id="line213">213.</a>
<a id="line214">214.</a>
  </pre>
  <pre class="prettyprint" style="display:inline-block">/**
 * @ngdoc directive
 * @memberof ngMap
 * @name map
 * @requires Attr2Options
 * @description
 *   Implementation of {@link MapController}
 *   Initialize a Google map within a `&lt;div>` tag with given options and register events
 *   It accepts children directives; marker, shape, or marker-clusterer
 *
 *   It initialize map, children tags, then emits message as soon as the action is done
 *   The message emitted from this directive is;
 *     . mapInitialized
 *
 *   Restrict To:
 *     Element
 *
 * @param {Expression} geo-callback if center is an address or current location, the expression is will be executed when geo-lookup is successful. e.g., geo-callback="showMyStoreInfo()"
 * @param {Array} geo-fallback-center 
 *    The center of map incase geolocation failed. i.e. [0,0]
 * @param {Boolean} zoom-to-include-markers
 *    When true, map boundary will be changed automatially to include all markers when initialized
 * @param {Boolean} default-style
 *    When false, the default styling, `display:block;height:300px`, will be ignored.
 * @param {String} init-event The name of event to initialize this map. 
 *    If this option is given, the map won't be initialized until the event is received.
 *    To invoke the event, use $scope.$emit or $scope.$broacast. 
 *    i.e. &lt;map init-event="init-map" ng-click="$emit('init-map')" center=... >&lt;/map>
 * @param {String} &lt;MapOption> Any Google map options, 
 *    https://developers.google.com/maps/documentation/javascript/reference?csw=1#MapOptions
 * @param {String} &lt;MapEvent> Any Google map events, 
 *    https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/map_events.html
 * @example
 * Usage:
 *   &lt;map MAP_OPTIONS_OR_MAP_EVENTS ..>
 *     ... Any children directives
 *   &lt;/map>
 * 
 * Example:
 *   &lt;map center="[40.74, -74.18]" on-click="doThat()">
 *   &lt;/map>
 *
 *   &lt;map geo-fallback-center="[40.74, -74.18]" zoom-to-inlude-markers="true">
 *   &lt;/map>
 */
/* global google */
(function() {
  'use strict';

  function getStyle(el,styleProp) {
    var y;
    if (el.currentStyle) {
      y = el.currentStyle[styleProp];
    } else if (window.getComputedStyle) {
      y = document.defaultView.getComputedStyle(el,null).getPropertyValue(styleProp);
    }
    return y;
  }

  var mapDirective = function(Attr2Options, $timeout, $parse) {
    var parser = Attr2Options;

    /**
     * Initialize map and events
     * @memberof map
     * @param {$scope} scope
     * @param {angular.element} element
     * @param {Hash} attrs
     * @ctrl {MapController} ctrl
     */
    var linkFunc = function(scope, element, attrs, ctrl) {
      var orgAttrs = parser.orgAttributes(element);

      scope.google = google;  //used by $scope.eval in Attr2Options to avoid eval()

      /**
       * create a new `div` inside map tag, so that it does not touch map element
       * https://stackoverflow.com/questions/20955356
       */
      var el = document.createElement("div");
      el.style.width = "100%";
      el.style.height = "100%";
      element.prepend(el);

      /**
       * if style is not given to the map element, set display and height
       */
      if (attrs.defaultStyle !== 'false') {
        if (getStyle(element[0], 'display') != "block") {
          element.css('display','block');
        }
        if (getStyle(element[0], 'height').match(/^(0|auto)/)) {
          element.css('height','300px');
        }
      }

      /**
       * disable drag event
       */
      element[0].addEventListener('dragstart', function(event) {
        event.preventDefault();
        return false;
      });

      /**
       * initialize function
       */
      var initializeMap = function(mapOptions, mapEvents) {
        var map = new google.maps.Map(el, {});
        map.markers = {};
        map.shapes = {};
       
        /**
         * resize the map to prevent showing partially, in case intialized too early
         */
        $timeout(function() {
          google.maps.event.trigger(map, "resize");
        });

        /**
         * set options
         */
        mapOptions.zoom = mapOptions.zoom || 15;
        var center = mapOptions.center;
        if (!center) {
          mapOptions.center = new google.maps.LatLng(0,0);
        } else if (!(center instanceof google.maps.LatLng)) {
          delete mapOptions.center;
          ctrl.getGeoLocation(center).then(function(latlng) {
            map.setCenter(latlng);
            var geoCallback = attrs.geoCallback;
            geoCallback && $parse(geoCallback)(scope);
          }, function(error) {
            map.setCenter(options.geoFallbackCenter);
          });
        }
        map.setOptions(mapOptions);

        /**
         * set events
         */
        for (var eventName in mapEvents) {
          if (eventName) {
            google.maps.event.addListener(map, eventName, mapEvents[eventName]);
          }
        }

        /**
         * set observers
         */
        ctrl.observeAttrSetObj(orgAttrs, attrs, map);

        /**
         * set controller and set objects
         * so that map can be used by other directives; marker or shape 
         * ctrl._objects are gathered when marker and shape are initialized before map is set
         */
        ctrl.map = map;   /* so that map can be used by other directives; marker or shape */
        ctrl.addObjects(ctrl._objects);

        // /* providing method to add a marker used by user scope */
        // map.addMarker = ctrl.addMarker;

        /**
         * set map for scope and controller and broadcast map event
         * scope.map will be overwritten if user have multiple maps in a scope,
         * thus the last map will be set as scope.map.
         * however an `mapInitialized` event will be emitted every time.
         */
        scope.map = map;
        scope.map.scope = scope;
        google.maps.event.addListenerOnce(map, "idle", function() {
          scope.$emit('mapInitialized', map);  
          if (attrs.zoomToIncludeMarkers == 'auto') {
            scope.$on('objectChanged', function(evt, msg) {
              console.log('objectChanged name', msg);
              msg[0] == 'markers' && ctrl.zoomToIncludeMarkers();
            });
          }else if (attrs.zoomToIncludeMarkers) {
            console.log('zoomToIncludeMarkers');
            ctrl.zoomToIncludeMarkers();
          }
        });
      }; // function initializeMap()

      /**
       * get map options and events
       */
      var filtered = parser.filter(attrs);
      var options = parser.getOptions(filtered, scope);
      var controlOptions = parser.getControlOptions(filtered);
      var mapOptions = angular.extend(options, controlOptions);
      var mapEvents = parser.getEvents(scope, filtered);
      console.log("filtered", filtered, "mapOptions", mapOptions, 'mapEvents', mapEvents);

      if (attrs.initEvent) { // allows controlled initialization
        scope.$on(attrs.initEvent, function() {
          !ctrl.map && initializeMap(mapOptions, mapEvents); // init if not done
        });
      } else {
        initializeMap(mapOptions, mapEvents);
      } // if
    };

    return {
      restrict: 'AE',
      controller: 'MapController',
      link: linkFunc
    }; 
  };

  angular.module('ngMap').directive('map', ['Attr2Options', '$timeout', '$parse', mapDirective]);
})();

  </pre>
</body>
