<head>
  <link href="../css/prettify.css" type="text/css" rel="stylesheet">
  <script src="../js/prettify.js"></script>
</head>
<body onload="prettyPrint()">
  <div>Path: /Users/allen/github/angularjs-google-maps/directives/map_controller.js</div>
  <div>TOC: [object Object]</div>
  <div>Total Number Of Lines: 185</div>
  <pre style="display:inline-block;text-align:right"><a id="line1">1.</a>
<a id="line2">2.</a>
<a id="line3">3.</a>
<a id="line4">4.</a>
<a id="line5">5.</a>
<a id="line6">6.</a>
<a id="line7">7.</a>
<a id="line8">8.</a>
<a id="line9">9.</a>
<a id="line10">10.</a>
<a id="line11">11.</a>
<a id="line12">12.</a>
<a id="line13">13.</a>
<a id="line14">14.</a>
<a id="line15">15.</a>
<a id="line16">16.</a>
<a id="line17">17.</a>
<a id="line18">18.</a>
<a id="line19">19.</a>
<a id="line20">20.</a>
<a id="line21">21.</a>
<a id="line22">22.</a>
<a id="line23">23.</a>
<a id="line24">24.</a>
<a id="line25">25.</a>
<a id="line26">26.</a>
<a id="line27">27.</a>
<a id="line28">28.</a>
<a id="line29">29.</a>
<a id="line30">30.</a>
<a id="line31">31.</a>
<a id="line32">32.</a>
<a id="line33">33.</a>
<a id="line34">34.</a>
<a id="line35">35.</a>
<a id="line36">36.</a>
<a id="line37">37.</a>
<a id="line38">38.</a>
<a id="line39">39.</a>
<a id="line40">40.</a>
<a id="line41">41.</a>
<a id="line42">42.</a>
<a id="line43">43.</a>
<a id="line44">44.</a>
<a id="line45">45.</a>
<a id="line46">46.</a>
<a id="line47">47.</a>
<a id="line48">48.</a>
<a id="line49">49.</a>
<a id="line50">50.</a>
<a id="line51">51.</a>
<a id="line52">52.</a>
<a id="line53">53.</a>
<a id="line54">54.</a>
<a id="line55">55.</a>
<a id="line56">56.</a>
<a id="line57">57.</a>
<a id="line58">58.</a>
<a id="line59">59.</a>
<a id="line60">60.</a>
<a id="line61">61.</a>
<a id="line62">62.</a>
<a id="line63">63.</a>
<a id="line64">64.</a>
<a id="line65">65.</a>
<a id="line66">66.</a>
<a id="line67">67.</a>
<a id="line68">68.</a>
<a id="line69">69.</a>
<a id="line70">70.</a>
<a id="line71">71.</a>
<a id="line72">72.</a>
<a id="line73">73.</a>
<a id="line74">74.</a>
<a id="line75">75.</a>
<a id="line76">76.</a>
<a id="line77">77.</a>
<a id="line78">78.</a>
<a id="line79">79.</a>
<a id="line80">80.</a>
<a id="line81">81.</a>
<a id="line82">82.</a>
<a id="line83">83.</a>
<a id="line84">84.</a>
<a id="line85">85.</a>
<a id="line86">86.</a>
<a id="line87">87.</a>
<a id="line88">88.</a>
<a id="line89">89.</a>
<a id="line90">90.</a>
<a id="line91">91.</a>
<a id="line92">92.</a>
<a id="line93">93.</a>
<a id="line94">94.</a>
<a id="line95">95.</a>
<a id="line96">96.</a>
<a id="line97">97.</a>
<a id="line98">98.</a>
<a id="line99">99.</a>
<a id="line100">100.</a>
<a id="line101">101.</a>
<a id="line102">102.</a>
<a id="line103">103.</a>
<a id="line104">104.</a>
<a id="line105">105.</a>
<a id="line106">106.</a>
<a id="line107">107.</a>
<a id="line108">108.</a>
<a id="line109">109.</a>
<a id="line110">110.</a>
<a id="line111">111.</a>
<a id="line112">112.</a>
<a id="line113">113.</a>
<a id="line114">114.</a>
<a id="line115">115.</a>
<a id="line116">116.</a>
<a id="line117">117.</a>
<a id="line118">118.</a>
<a id="line119">119.</a>
<a id="line120">120.</a>
<a id="line121">121.</a>
<a id="line122">122.</a>
<a id="line123">123.</a>
<a id="line124">124.</a>
<a id="line125">125.</a>
<a id="line126">126.</a>
<a id="line127">127.</a>
<a id="line128">128.</a>
<a id="line129">129.</a>
<a id="line130">130.</a>
<a id="line131">131.</a>
<a id="line132">132.</a>
<a id="line133">133.</a>
<a id="line134">134.</a>
<a id="line135">135.</a>
<a id="line136">136.</a>
<a id="line137">137.</a>
<a id="line138">138.</a>
<a id="line139">139.</a>
<a id="line140">140.</a>
<a id="line141">141.</a>
<a id="line142">142.</a>
<a id="line143">143.</a>
<a id="line144">144.</a>
<a id="line145">145.</a>
<a id="line146">146.</a>
<a id="line147">147.</a>
<a id="line148">148.</a>
<a id="line149">149.</a>
<a id="line150">150.</a>
<a id="line151">151.</a>
<a id="line152">152.</a>
<a id="line153">153.</a>
<a id="line154">154.</a>
<a id="line155">155.</a>
<a id="line156">156.</a>
<a id="line157">157.</a>
<a id="line158">158.</a>
<a id="line159">159.</a>
<a id="line160">160.</a>
<a id="line161">161.</a>
<a id="line162">162.</a>
<a id="line163">163.</a>
<a id="line164">164.</a>
<a id="line165">165.</a>
<a id="line166">166.</a>
<a id="line167">167.</a>
<a id="line168">168.</a>
<a id="line169">169.</a>
<a id="line170">170.</a>
<a id="line171">171.</a>
<a id="line172">172.</a>
<a id="line173">173.</a>
<a id="line174">174.</a>
<a id="line175">175.</a>
<a id="line176">176.</a>
<a id="line177">177.</a>
<a id="line178">178.</a>
<a id="line179">179.</a>
<a id="line180">180.</a>
<a id="line181">181.</a>
<a id="line182">182.</a>
<a id="line183">183.</a>
<a id="line184">184.</a>
<a id="line185">185.</a>
  </pre>
  <pre class="prettyprint" style="display:inline-block">/* global google */
(function() {
  'use strict';

  /**
   * @ngdoc controller
   * @name MapController
   * @requires $scope
   * @property {Hash} controls collection of Controls initiated within `map` directive
   * @property {Hash} markers collection of Markers initiated within `map` directive
   * @property {Hash} shapes collection of shapes initiated within `map` directive
   */
  var MapController = function($scope, $q, NavigatorGeolocation, GeoCoder, Attr2Options) { 
    var parser = Attr2Options;
    var _this = this;

    var observeAndSet = function(attrs, attrName, object) {
      attrs.$observe(attrName, function(val) {
        if (val) {
          console.log('observing ', object, attrName, val);
          var setMethod = parser.camelCase('set-'+attrName);
          var optionValue = parser.toOptionValue(val, {key: attrName});
          console.log('setting ', object, attrName, 'with value', optionValue);
          if (object[setMethod]) { //if set method does exist
            /* if an location is being observed */
            if (attrName.match(/center|position/) && 
              typeof optionValue == 'string') {
              _this.getGeoLocation(optionValue).then(function(latlng) {
                object[setMethod](latlng);
              });
            } else {
              object[setMethod](optionValue);
            }
          }
        }
      });
    };

    this.map = null;
    this._objects = []; /* temporary collection of map objects */

    /**
     * Add an object to the collection of group
     * @memberof MapController
     * @function addObject
     * @param groupName the name of collection that object belongs to
     * @param obj  an object to add into a collection, i.e. marker, shape
     */
    this.addObject = function(groupName, obj) {
      /**
       * objects, i.e. markers and shapes, are initialized before map is initialized
       * so, we collect those objects, then, we will add to map when map is initialized
       * However the case as in ng-repeat, we can directly add to map
       */
      if (this.map) {
        this.map[groupName] = this.map[groupName] || {};
        var len = Object.keys(this.map[groupName]).length;
        this.map[groupName][obj.id || len] = obj;
        if (groupName != "infoWindows" && obj.setMap) { //infoWindow.setMap works like infoWindow.open
          obj.setMap && obj.setMap(this.map);
        }
        if (obj.centered && obj.position) {
          this.map.setCenter(obj.position);
        }
        $scope.$emit('objectChanged', [groupName, this.map[groupName]]);
      } else {
        obj.groupName = groupName;
        this._objects.push(obj);
      }
    };

    /**
     * Delete an object from the collection and remove from map
     * @memberof MapController
     * @function deleteObject
     * @param {Array} objs the collection of objects. i.e., map.markers
     * @param {Object} obj the object to be removed. i.e., marker
     */
    this.deleteObject = function(groupName, obj) {
      /* delete from group */
      if (obj.map) {
        var objs = obj.map[groupName];
        for (var name in objs) {
          objs[name] === obj && (delete objs[name]);
        }

        /* delete from map */
        obj.map && obj.setMap && obj.setMap(null);
        $scope.$emit('objectChanged', [groupName, this.map[groupName]]);
      }
    };

    /**
     * Add collected objects to map
     * @memberof MapController
     * @function addObjects
     * @param {Array} objects the collection of objects. i.e., map.markers
     */
    this.addObjects = function(objects) {
      for (var i=0; i&lt;objects.length; i++) {
        var obj=objects[i];
        if (obj instanceof google.maps.Marker) {
          this.addObject('markers', obj);
        } else if (obj instanceof google.maps.Circle ||
          obj instanceof google.maps.Polygon ||
          obj instanceof google.maps.Polyline ||
          obj instanceof google.maps.Rectangle ||
          obj instanceof google.maps.GroundOverlay) {
          this.addObject('shapes', obj);
        } else {
          this.addObject(obj.groupName, obj);
        }
      }
    };

    /**
     * returns the location of an address or 'current-location'
     * @memberof MapController
     * @function getGeoLocation
     * @param {String} string an address to find the location
     * @returns {Promise} latlng the location of the address
     */
    this.getGeoLocation = function(string) {
      var deferred = $q.defer();
      if (!string || string.match(/^current/i)) { // current location
        NavigatorGeolocation.getCurrentPosition().then(
          function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var latLng = new google.maps.LatLng(lat,lng);
            deferred.resolve(latLng);
          },
          function(error) {
            deferred.reject(error);
          }
        );
      } else {
        GeoCoder.geocode({address: string}).then(
          function(results) {
            deferred.resolve(results[0].geometry.location);
          },
          function(error) {
            deferred.reject(error);
          }
        );
      }

      return deferred.promise;
    };

    /**
     * watch changes of attribute values and do appropriate action based on attribute name
     * @memberof MapController
     * @function observeAttrSetObj
     * @param {Hash} orgAttrs attributes before its initialization
     * @param {Hash} attrs    attributes after its initialization
     * @param {Object} obj    map object that an action is to be done
     */
    this.observeAttrSetObj = function(orgAttrs, attrs, obj) {
      var attrsToObserve = parser.getAttrsToObserve(orgAttrs);
      if (Object.keys(attrsToObserve).length) {
        console.log(obj, "attributes to observe", attrsToObserve);
      }
      for (var i=0; i&lt;attrsToObserve.length; i++) {
        observeAndSet(attrs, attrsToObserve[i], obj);
      }
    };

    /**
     * include all markers
     */
    this.zoomToIncludeMarkers = function() {
      var bounds = new google.maps.LatLngBounds();
      for (var marker in this.map.markers) {
        bounds.extend(this.map.markers[marker].getPosition());
      }
      this.map.fitBounds(bounds);
    };

  }; // MapController

  MapController.$inject = ['$scope', '$q', 'NavigatorGeolocation', 'GeoCoder', 'Attr2Options'];
  angular.module('ngMap').controller('MapController', MapController);
})();

  </pre>
</body>
